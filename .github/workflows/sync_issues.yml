name: Sync Issues from Multiple Repos

on:
  schedule:
    - cron: '*/30 * * * *'  # Runs every 30 minutes
  workflow_dispatch:  # Allows manual triggering

jobs:
  sync-issues:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        
      - name: Install jq
        run: sudo apt-get install jq -y
        
      - name: Sync Issues
        env:
          GH_PAT: ${{ secrets.GH_PAT }}
          AGGREGATION_REPO: "Org1/issue-aggregator"
          SOURCE_REPOS: "Xt-EHR/xt-ehr-metadata,Xt-EHR/xt-ehr-common,IHE/pharm-mpd"
        run: |
          echo "SOURCE_REPOS is: $SOURCE_REPOS"
          
          for repo in $(echo $SOURCE_REPOS | tr "," "\n"); do
            echo "Fetching issues from $repo"
          
            # Fetch issues and print raw response for debugging
            issues=$(curl -s -H "Authorization: token $GH_PAT" \
                          -H "Accept: application/vnd.github.v3+json" \
                          "https://api.github.com/repos/$repo/issues?state=open")

            # Debugging: Print first few characters of the response
            echo "GitHub API response (truncated): $(echo "$issues" | cut -c1-500)"
            
            # Ensure we have valid JSON before proceeding
            if echo "$issues" | jq empty 2>/dev/null; then
              echo "$issues" | jq -c '.[]' | while read -r issue; do
                issue_number=$(echo "$issue" | jq -r '.number')
                issue_title=$(echo "$issue" | jq -r '.title')
                issue_body=$(echo "$issue" | jq -r '.body // "No description provided."')  # Handle null body safely
                issue_url=$(echo "$issue" | jq -r '.html_url')

                echo "Processing issue #$issue_number: $issue_title"

                # Check if issue already exists
                search_response=$(curl -s -H "Authorization: token $GH_PAT" \
                                        -H "Accept: application/vnd.github.v3+json" \
                                        "https://api.github.com/search/issues?q=repo:$AGGREGATION_REPO $issue_url")

                existing_issue=$(echo "$search_response" | jq -r '.total_count // 0')

                echo "Checking if issue exists: $issue_title"
                echo "Extracted issue count: $existing_issue"

                # Ensure existing_issue is a valid number
                if [[ "$existing_issue" =~ ^[0-9]+$ ]] && [ "$existing_issue" -eq 0 ]; then
                  echo "Creating issue: $issue_title"
                  
                  create_response=$(curl -s -X POST -H "Authorization: token $GH_PAT" \
                                    -H "Accept: application/vnd.github.v3+json" \
                                    "https://api.github.com/repos/$AGGREGATION_REPO/issues" \
                                    -d "{\"title\": \"[Mirror] $issue_title\", \"body\": \"**Original Issue:** [$issue_url]($issue_url)\n\n$issue_body\"}")

                  # Check if creation was successful
                  if echo "$create_response" | jq -e '.id' >/dev/null; then
                    echo "Issue created successfully!"
                  else
                    echo "Error creating issue: $create_response"
                  fi

                else
                  echo "Issue already exists: $issue_title"
                fi
              done
            else
              echo "⚠️ Invalid JSON received from GitHub API. Possible rate limit or bad response."
              exit 1
            fi
          done
